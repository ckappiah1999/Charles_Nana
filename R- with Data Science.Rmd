---
title: "Fun stuffs"
author: "Charles"
date: "2025-03-24"
output:
  word_document: default
  html_document:
    df_print: paged
    code_download: true
    theme: journal
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
## **Chapter One**

### Simple Expressions

2 + 4 # Addition

4 / 2 # Division
```
``` {r}
3 * 4 # Multiplication

45 - 13 # Subtraction

4L / 5L # Integer Division

4 %% 3 # for integer division with remainder

2 ^ 5 # Exponential

3 ** 4 # Indices

9 ** 3 # Indices
```
``` {r}
s = "Hello Charles, I hope you are working smart to achieve your dream?"
s

e <- 34 # Assigning variable (e) to  value (34)
e
nchar(e) # number of characters

3 -> r # Assigning variable (r) to  value (3)
r
```

```{r}
(u <- "Nana Kwame") # parentheses form will print an output
nchar(u) # number of characters

q = seq( 1,50,2) # Start from 1 and end at 50 with a step of 2
q

q[23] # checking for index of the sequence
q[20] # checking for index of the sequence
q[2:9] # checking form index 2 to index 9

q ** 2 - r
```

```{r}
v <- c("A" = 1, "B" = 2, "C" = 3) # Creating keys and values
v

names(v) <- c("x", "y", "z") # Assigning new keys to the values
v

v["x"] # checking the key x
v["y"] # checking the key y
```
```{r}
(x <- 1:4) # parentheses form will print an output

(y <- 4:7) # parentheses form will print an output

x - y 
```

```{r}
#?nchar

#?`+`

square <- function(x) x**2
square(1:4)

cube = function(x) x**3
cube(1:9)

square_and_subtract <- function(x, y) return(x ** 2 - y)
square_and_subtract(30,30)

sum(1:4)

1 : 4

sqrt(1:4)
```
``` {r}
average <- function(x) {
 n <- length(x)
 sum(x) / n
}
average(1:9)

mean(1:9)

mean <- function(x) sum(x) / length(x)

mean(2:24)
```
```{r}
### **Controls loops** 

if (3 > 2) "true"

if (2 < 3) "false" else "true"

if (2 > 3) "bar" else "baz"

if (5 > 4) "Charles" else "Nana"

if (2 > 3) {
 x <- "bar"
}else "baz"
```
```{r}
x <- 1:5
ifelse(x > 3, "bar", "baz")

maybe_square <- function(x) {
 ifelse (x %% 2 == 0, x ** 2, x)
}
maybe_square(1:9)
```
``` {r}
xo <- 1:5 # Assigning values (1 to 5) to variable xo
total <- 0
for (element in xo) total <- total + element
total
xo
```
```{r}
x <- 1:5
total <- 0
for (index in seq_along(x)) {
 element <- x[index]
 total <- total + element
}
total
```
``` {r}
x = -1:-5 # Assigning values (-1 to - 5) to variable x
total <- 9
index <- 1
while (index <= length(x)) {
 element <- x[index]
 index <- index + 1
 total <- total + element
}
total
x
summary(x)
```
``` {r}
### Factors
f <- factor(c("small", "small", "medium",
 "large", "small", "large"))
f
ordered(f)
summary(f)
```
```{r}
ff <- factor(c("small", "small", "medium",
 "large", "small", "large"),
 levels = c("small", "medium", "large")) # changing the levels of ff
ff
ordered(ff)
summary(ff)
```
```{r}
f <- factor(c("small", "small", "medium",
 "large", "small", "large"),
 levels = c("medium", "small", "large"),
 ordered = TRUE)
f
summary(f)
```
```{r}
v <- 1:26
names(v) <- LETTERS[1:26] # Extracting the name of the letters with numbers
v

(ffo <- factor(LETTERS[1:4]))
v[ffo] # Assigning values to the letters

(ff <- factor(LETTERS[1:4], levels = rev(LETTERS[1:4]))) 
v[ff]

as.numeric(ff) # Number form
as.vector(ff) # String form
v[as.vector(ff)]
```
```{r}
### Data Frames
df <- data.frame(a = 1:4, b = letters[1:4]) # Creating a data frame
df
df[1,1] # row one , column one
df[1,2] # row one , column two
df[2,1] # row two , column one
df[2,2] # row two , column two
df[1,] # All row one values
df[,1] # All column one values
df[,"a"] # using the column name
df$b # using the column name
```

```{r}
df2 <- data.frame(a = 5:7, b = letters[5:7])
rbind(df, df2) ### Combining them using their rows

df3 <- data.frame(c = 5:8, d = letters[5:8])
cbind(df, df3) ### Combining them using their columns

df4 = data.frame(Random = rnorm(26), Alphabets =  letters)
df4
```
```{r}
### Missing Values
NA + 5

is.na(NA) # checking for a missing number

is.na(4) # checking if 4 is a missing number

v <- c(1:100,NA)
sum(v)
sum(v, na.rm = TRUE)



### **R Packages**
#install.packages("magrittr")
library(magrittr)
```
```{r data}
### Data Pipeline
subsample_rows <- function(d, n) {
 rows <- sample(nrow(d), n)
 d[rows,]
}

d <- data.frame(x = rnorm(100), y = rnorm(100))

d %>% subsample_rows(n = 3)
```
``` {r}
do <- data.frame(x = rnorm(100), y = rnorm(100))
do %>% lm(y ~ x, data = .)
```

```{r}
so <- data.frame(x = 1:10, y = 11:20)
so %>% lm(y ~ x, data = .)
```
``` {r}
#?lm()

rnorm(4) %>% data.frame(x = ., is_negative = . < 0)

rnorm(4) %>% data.frame(x = ., y = abs(.))

rnorm(4) %>% data.frame(x = sin(.), y = cos(.))

#sin(1.03130453)
#cos(1.03130453)
```
``` {r}
f <- function(x, y) {
 y <- sum(cos(x),sin(y)) 
 z <- sum(sin(x),cos(y))
 z
}

f(2,4)
```
```{r}
plot_and_fit <- function(d) {
 plot(y ~ x, data = d)
 abline(lm(y ~ x, data = d))
}

x <- rnorm(20)
y <- x + rnorm(20)
data.frame(x, y) %>% plot_and_fit
```

```{r}
data.frame(x, y) %>% (function(d) {
 plot(y ~ x, data = d)
 abline(lm(y ~ x, data = d))
})
```
```{r}
data.frame(x, y) %>% {
 plot(y ~ x, data = .)
 abline(lm(y ~ x, data = .))
}
```
```{r}
d <- data.frame(x = rnorm(100), y = 4 + rnorm(100))

#d %>% {data.frame(mean_x = mean(.$x), mean_y = mean(.$y))}

d %$% data.frame(mean_x = mean(x), mean_y = mean(y))

d <- data.frame(x = rnorm(10), y = rnorm(10))

d %T>% plot(y ~ x, data = .) %>% lm(y ~ x, data = .)
```
```{r warning=FALSE}
## **Chapter Three**

### Data Manipulation
library(datasets)
library(ggplot2)
#library(help = "datasets")

data(cars)
head(cars)
cars %>% head(3) ### First 3 rows of the cars datasets
cars %>% tail(3) ### Last 3 rows of the cars datasets
cars %>% summary ### Summary of the cars datasets
cars %>% qplot(speed, dist, data = .)
```

```{r}
#install.packages("mlbench")
library(mlbench)
#library(help = "mlbench")

data(iris)
head(iris)
iris %>% head(5)
iris %>% summary ### Summary of the iris datasets
iris %>% qplot(Sepal.Length, Sepal.Width, data = ., color = Species)
iris %>% qplot(Petal.Length, Petal.Width, data = ., color = Species)
```

```{r}
#?read.table
#### **Breast Cancer**
data(BreastCancer)
BreastCancer %>% head()
data_url = "http://tinyurl.com/kw4xtts"
lines <- readLines(data_url)
lines[1:5]
```

```{r}
raw_breast_cancer = read.csv("C:/Users/HP/Desktop/Data Science/Machine learning/breast+cancer+wisconsin+original/breast-cancer-wisconsin.data")
raw_breast_cancer  %>% head(6)
```
```{r}
raw_breast_cancer <- read.csv(data_url)
raw_breast_cancer %>% head()
```
```{r}
raw_breast_cancer <- read.csv(data_url, header = FALSE)
raw_breast_cancer %>% head()
```
```{r}
names(raw_breast_cancer) <- names(BreastCancer)
raw_breast_cancer %>% head()
```
```{r}
raw_breast_cancer <- read.csv(data_url, header = FALSE,
 col.names = names(BreastCancer))
raw_breast_cancer %>% head()
```
```{r}
formatted_breast_cancer <- raw_breast_cancer

#mapped <- formatted_breast_cancer$Class %>% map_class
#mapped %>% table

map_class <- function(x) {
 ifelse(x == 2, "bening", "malignant")
}
mapped <- formatted_breast_cancer$Class %>% map_class
mapped %>% table

formatted_breast_cancer$Class %>% unique

#dict <- c("2" = "benign", "4" = "malignant")
#map_class <- function(x) dict[as.character(x)]

#mapped <- formatted_breast_cancer$Class %>% map_class
#mapped %>% table
```

```{r}
mapped[1:20]

#mapped %<>% unname
#mapped[1:20]

read = read.csv(data_url, header = FALSE,
 col.names = names(BreastCancer)) ->
 raw_breast_cancer ->
 formatted_breast_cancer
dict <- c("2" = "benign", "4" = "malignant")
map_class <- function(x) dict[as.character(x)]
formatted_breast_cancer$Class <-
 formatted_breast_cancer$Class %>%
 map_class %>%
 unname %>%
 factor(levels = c("benign", "malignant"))

read

raw_breast_cancer$Class %>%
 { dict <- c("2" = "benign", "4" = "malignant")
 dict[as.character(.)]
 } %>%
 unname %>%
 factor(levels = c("benign", "malignant")) %>%
 table
```
```{r}
### Saving a file
formatted_breast_cancer %>%
save(file = "C:/Users/HP/Desktop/Data Science/Learning R Language/formatted-breast-cancer.rda")

### loading a saved file  
load("C:/Users/HP/Desktop/Data Science/Learning R Language/formatted-breast-cancer.rda") 
```



```{r}
#data(DNA)
#str(DNA)

### Boston Housing Datasets
data(BostonHousing)
str(BostonHousing)

boston <- "http://tinyurl.com/zq2u8vx"
```
```{r}
#data(BostonHousing2)
#str(BostonHousing2)
```

```{r}
#boston_housing <- read.table(boston)
#str(boston_housing)

col_classes <- rep("numeric", length(BostonHousing))
col_classes[which("chas" == names(BostonHousing))] <- "factor"

#boston_housing <- read.table(boston,col.names = names(BostonHousing),colClasses = col_classes)
#str(boston_housing)
```

```{r BreastCancer}
### Readr Package
library(readr)

raw_breast_cancer <- read_csv("C:/Users/HP/Desktop/Data Science/Machine learning/breast+cancer+wisconsin+original/breast-cancer-wisconsin.data",show_col_types = "TRUE", col_names = names(BreastCancer))
raw_breast_cancer %>% head()
```
```{r}
raw_breast_cancer <- read_csv("C:/Users/HP/Desktop/Data Science/Machine learning/breast+cancer+wisconsin+original/breast-cancer-wisconsin.data",
 col_names = names(BreastCancer), show_col_types = "TRUE")
raw_breast_cancer %>% head()
```
```{r warning=FALSE}
### Manipulating Data with dplyr
library(tidyverse)

iris %>% tibble::as_tibble()
iris %>% tbl_df %>% select(Species,Petal.Width) %>% head()
iris %>% tbl_df %>% select(Species,Sepal.Width) %>% head()
iris %>% tbl_df %>% select(Species,Petal.Length) %>% head()
iris %>% tbl_df %>% select(Species,Sepal.Length) %>% head()
```

```{r warning=FALSE}
iris %>% tbl_df %>%
select(Sepal.Width, Petal.Width) %>% head() ## Select from Sepal.Width and Petal.Width
```

```{r Excluding Petal.Width , warning=FALSE}
iris %>% tbl_df %>% select(Sepal.Length:Petal.Length) %>% head() ## Select from Sepal.Width to Petal.length
```

```{r Petal only, warning=FALSE}
iris %>% tbl_df %>% select(starts_with("Petal")) %>% head() ## Select Petal.Length and Width only
```

```{r Length Only, warning=FALSE}
iris %>% tbl_df %>%
select(ends_with("Length")) %>% head()
```

```{r etal Only, warning=FALSE}
iris %>% tbl_df %>%
select(contains("etal")) %>% head()
```

```{r al Only, warning=FALSE}
iris %>% tbl_df %>% select(contains("al")) %>% head()
```
```{r Without Petal, warning=FALSE}
iris %>% tbl_df %>%
select(matches(".t.")) %>% head()

iris %>% tbl_df %>%
 select(-starts_with("Petal")) %>% head() ### inverse selection
```
```{r Petal. (Width + Length), warning=FALSE}
iris %>% tbl_df %>%
 mutate(Petal.Width.plus.Length = Petal.Width + Petal.Length) %>%select(Species, Petal.Width.plus.Length) %>%head()
```
```{r Sepal. (Width + Length), warning=FALSE}
iris %>% tbl_df %>% mutate(Sepal.Width.plus.Length = Sepal.Width + Sepal.Length) %>%select(Species, Sepal.Width.plus.Length) %>%head()
```
```{r Petal,Sepal.(Width + Length), warning=FALSE}
iris %>% tbl_df %>%mutate(Petal.Width.plus.Length = Petal.Width + Petal.Length,Sepal.Width.plus.Length = Sepal.Width + Sepal.Length) %>%select(Species,Petal.Width.plus.Length, Sepal.Width.plus.Length) %>% head()
```
```{r Mutate.Select, warning=FALSE}
iris %>% tbl_df %>%transmute(Species ,Petal.Width.plus.Length = Petal.Width + Petal.Length) %>%
 head()
```
```{r Small to large, warning=FALSE}
iris %>% tbl_df %>% arrange(Sepal.Length) %>% head() 
#from smallest to largest in Sepal.Length column
```

```{r Small.Large, warning=FALSE}
iris %>% tbl_df %>% arrange(Petal.Width) %>% head()
#from smallest to largest in Sepal.Length column
```
```{r Large.Small, warning=FALSE}
iris %>% tbl_df %>%
 arrange(desc(Sepal.Length)) %>%
 head() ### from largest to smallest in Sepal.Length column
``` 
```{r Values >= 5, warning=FALSE}
iris %>% tbl_df %>%
 filter(Sepal.Length >= 5) %>%
 head()
```
```{r warning=FALSE, Values <=1.4}
iris %>% tbl_df %>%
 filter(Petal.Length <= 1.4) %>%
 head()
``` 
```{r Values > 5 and virginica, warning=FALSE}
iris %>% tbl_df %>%filter(Sepal.Length > 5 & Species == "virginica") %>%select(Species, Sepal.Length) %>%head() 
``` 
```{r Species grouping, warning=FALSE}
iris %>% tbl_df %>% group_by(Species) %>% head()
``` 
```{r Mean_Length, warning=FALSE}
iris %>% summarise(Mean.Petal.Length = mean(Petal.Length),
 Mean.Sepal.Length = mean(Sepal.Length))
```
```{r Std.Length, warning=FALSE}
iris %>% summarise(Std.Petal.Length = sd(Petal.Length), Std.Sepal.Length = sd(Sepal.Length))
```
```{r Mean.Width}
iris %>% summarise(Mean.Petal.Width = mean(Petal.Width),
 Mean.Sepal.Width = mean(Sepal.Width))
```
```{r Var.Width}
iris %>% summarise(Var.Petal.Width = var(Petal.Width), Var.Seapl.Width= var(Sepal.Width)) 
```
```{r Mean.Species.Petal}
iris %>%group_by(Species) %>%summarise(Mean.Petal.Length = mean(Petal.Length)) 
```
```{r Var.Species.Petal}
iris %>% group_by(Species) %>% summarise(Var.Petal.Length = var(Petal.Length))
```
```{r Mean.Species.Sepal}
iris %>% group_by(Species) %>% summarise(Mean.Sepal.Length = mean(Sepal.Length)) 
``` 
```{r Median.Species.Petal}
iris %>% group_by(Species)%>%
 summarize(Median.Petal.Width = median(Petal.Width))
``` 
```{r Median.Species.Sepal}
iris %>% group_by(Species)%>% summarize(Median.Sepal.Width = median(Sepal.Width))
``` 
```{r Total}
iris %>% summarise(Observations = n())
``` 
```{r Each Species}
iris %>%
 group_by(Species) %>%
 summarise(Number.Of.Species = n())
```
```{r Samples.Petal}
iris %>%group_by(Species) %>%summarise(Number.Of.Samples = n(), Mean.Petal.Length = mean(Petal.Length))
``` 
```{r Sample.Sepal}
iris %>%
 group_by(Species) %>%
 summarise(Number.Of.Samples = n(),
 Mean.Sepal.Length = mean(Sepal.Length))
```
```{r Class}
format_class <- . %>% {
 dict <- c("2" = "benign", "4" = "malignant")
 dict[as.character(.)]
} %>% unname %>% factor(levels = c("benign", "malignant"))

formatted_breast_cancer <-
 raw_breast_cancer %>% mutate(Class = format_class(Class)) 
 
formatted_breast_cancer %>%
 group_by(Class) %>%
 summarise(mean.Cl.thickness = mean(Cl.thickness)) 
 
formatted_breast_cancer %>%
 group_by(Class) %>%
 summarise(mean.Cell.size = mean(Cell.size))
```
```{r Cancer, message=FALSE, warning=FALSE}
formatted_breast_cancer %>%
 arrange(Cell.size) %>%
 group_by(Cell.size, Class) %>%
 summarise(ClassCount = n()) 
 
formatted_breast_cancer %>%
 group_by(Class, as.factor(Cell.size)) %>%
 summarise(mean.Cl.thickness = mean(Cl.thickness))

#formatted_breast_cancer %>%group_by(as.factor(Cell.size), Class) %>% summarise(mean.thickness = mean(Cl.thickness)) 
```
```{r Plot.1, message=FALSE}
iris %>% select(Species, Petal.Length) %>% head() 
 
iris %>% select(Species, Petal.Length) %>%
 qplot(Species, Petal.Length, geom = "boxplot", data = .) 
```
```{r Clean data}
#library(tidyr) 
iris %>%gather(key = Attribute, value = Measurement,Sepal.Length, Sepal.Width) %>%select(Species, Attribute, Measurement) %>% head() 
```
```{r Plot_facet, warning=FALSE}
iris %>%
 gather(key = Attribute, value = Measurement,
 Sepal.Length, Sepal.Width) %>% select(Species, Attribute, Measurement) %>% qplot(Attribute, Measurement, geom = "boxplot", facets = . ~ Species, data = .)
``` 
```{r Clean_2}
iris %>%
 gather(key = Attribute, value = Measurement,
 Petal.Length, Petal.Width) %>%
 select(Species, Attribute, Measurement) %>%
 head() 
```
```{r Plot_facet_3}
iris %>%
 gather(key = Attribute, value = Measurement,
 Petal.Length, Petal.Width) %>%
 select(Species, Attribute, Measurement) %>%
 qplot(Attribute, Measurement,
 geom = "boxplot",
 facets = . ~ Species, data = .)
```

```{r}
## **Chapter 4** 
### Visualizing Data
library(graphics)
x = rnorm(100)
y = rnorm(100)
plot(x,y, type="p", main ="X against Y", col = "red")
```
```{r}
data(cars)
cars %$% plot(speed, dist, main = "Cars data",
 xlab = "Speed", ylab = "Stopping distance")

cars %>% plot(dist ~ speed, data = ., main ="Cars data", col = "red")
```
```{r}
cars %$% plot(speed, dist, main = "Cars data", type = "h",
 xlab = "Speed", ylab = "Stopping Distance")

cars %$% plot(speed, dist, main = "Cars data", type = "s",
 xlab = "Speed", ylab = "Stopping Distance")

cars %$% hist(speed, col = "orange")
cars %$% hist(dist, col= "blue")

cars %>% lm(dist ~ speed, data = .) %>% plot ### Plotting Linear Models
```
```{r}
data = longley
data
longley %>% plot(Unemployed ~ Year, data = ., type = 'l')
longley %>% lines(Armed.Forces ~ Year, data = ., col = "blue")

longley %$% plot(Unemployed ~ Year, type = 'l',
 ylim = range(c(Unemployed, Armed.Forces)))
longley %>% lines(Armed.Forces ~ Year, data = ., col = "green")

as_tibble(longley)
```
```{r}
cars %>% plot(dist ~ speed, data = ., xlab="Speed", ylab="Stopping Distance")
cars %>% lm(dist ~ speed, data = .) %>% abline(col = "red")
```
```{r}
shape_map <- c("setosa" = 1, "versicolor" = 2,  "virginica" = 3) 

iris %$% plot(Petal.Length ~ Petal.Width, pch = shape_map[Species], col = Species)

iris %$% plot(Sepal.Length ~ Sepal.Width, pch = shape_map[Species], col = Species)

#cars %>% qplot(speed, dist, data = .)
```
```{r}
iris %>% qplot(Petal.Width, Petal.Length, color = Species, data = .)

iris %>% qplot(Sepal.Width, Sepal.Length, color = Species, data = .)

cars %>% qplot(speed, data = ., bins = 10) 
```
```{r} 
### Geometries
cars %>% qplot(speed, data = ., geom = "density")

cars %>% qplot (dist, data = ., geom = "density")

#cars %>% qplot(speed, dist, data = .)

ggplot(cars) + geom_point(aes(x = speed, y = dist))

#ggplot(cars, aes(x = speed, y = dist)) + geom_point()

#cars %>% ggplot(aes(x = speed, y = dist)) + geom_point()
```
```{r Col.Species}
iris %>% ggplot + geom_point(aes(x = Petal.Width, y = Petal.Length, color = Species))

iris %>% ggplot +
 geom_point(aes(x = Sepal.Width, y = Sepal.Length,
 color = Species))
```
```{r without.Species}
iris %>% ggplot +
 geom_point(aes(x = Petal.Width, y = Petal.Length),
 color = "black") 
```
```{r Cars}
cars %>% ggplot + geom_histogram(aes(x = speed), bins = 10)

cars %>% ggplot + geom_density(aes(x = speed))

cars %>% ggplot + geom_histogram(aes(x=dist), bins = 10)

cars %>% ggplot + geom_density(aes(x=dist))
```
```{r}
cars %>% ggplot(aes(x = speed, y = after_stat(count))) +
 geom_histogram(bins = 10) + geom_density()

cars %>% ggplot(aes(x = dist, y = after_stat(count))) + geom_histogram(bins = 10) + geom_density()
```
```{r Linear models}
cars %>% ggplot(aes(x = speed, y = dist)) +
 geom_point() + geom_smooth(method = "lm", formula =  y ~ x)

cars %>% ggplot(aes(x = speed, y = dist)) +
 geom_point() + geom_smooth( method = "loess",formula =  y ~ x) 
```
```{r Longley}
longley %>% ggplot(aes(x = Year)) + geom_line(aes(y = Unemployed)) + geom_line(aes(y = Armed.Forces), color = "blue") 
```
```{r Line.Point}
longley %>% ggplot(aes(x = Year)) + geom_point(aes(y = Unemployed)) + geom_point(aes(y = Armed.Forces), color = "blue") + geom_line(aes(y = Unemployed)) + geom_line(aes(y = Armed.Forces), color = "blue") 
```
```{r Legend.1}
longley %>% gather(key, value, Unemployed, Armed.Forces) %>%
 ggplot(aes(x = Year, y = value, color = key)) + geom_line() + geom_point()

longley %>% gather(key, value, Unemployed, Armed.Forces) %>%
 ggplot(aes(x = Year, y = value)) + geom_line() +
 facet_grid(key ~ .)  #### Facet row-wise with lines

longley %>% gather(key, value, Unemployed, Armed.Forces) %>%
 ggplot(aes(x = Year, y = value)) + geom_point() +
 facet_grid(key ~ .) #### Facet row-wise with points

longley %>% gather(key, value, Unemployed, Armed.Forces) %>%
 ggplot(aes(x = Year, y = value)) + geom_line() +
 facet_grid(. ~ key  ) #### Facet column-wise with lines

longley %>% gather(key, value, Unemployed, Armed.Forces) %>%
 ggplot(aes(x = Year, y = value)) + geom_point() +
 facet_grid(. ~ key) #### Facet column-wise with points
```
```{r Legend.2}
iris %>% gather(Measurement, Value, -Species) %>%
 ggplot(aes(x = Species, y = Value)) + geom_boxplot() +
 facet_grid(Measurement ~ .) # row-wise 

iris %>% gather(Measurement, Value, -Species) %>%
 ggplot(aes(x = Species, y = Value)) + geom_boxplot() +
 facet_grid(. ~ Measurement ) # Column wise
```
```{r Mapped}
iris %>% gather(Measurement, Value, -Species) %>%
 ggplot(aes(x = Species, y = Value)) +geom_boxplot() +
 facet_grid(Measurement ~ ., scale = "free_y") 

label_map <- c(Petal.Width = "Petal Width",
 Petal.Length = "Petal Length",
 Sepal.Width = "Sepal Width",
 Sepal.Length = "Sepal Length")
 
iris %>% gather(Measurement, Value, -Species) %>%
 ggplot(aes(x = Species, y = Value)) +
 geom_boxplot() + facet_grid(Measurement ~ ., scale = "free_y", labeller = labeller(Measurement = label_map))
```
```{r Continuous }
### Scaling 
cars %>% ggplot(aes(x = speed, y = dist)) + geom_point() + geom_smooth(method = "lm", formula =  y ~ x) + scale_x_continuous("Speed") + scale_y_continuous("Stopping Distance") 
 
longley %>% gather(key, value, Unemployed, Armed.Forces) %>%
 ggplot(aes(x = Year, y = value)) + geom_line() + geom_point() + scale_x_continuous(breaks = 1947:1962) +
 facet_grid(key ~ .)
```
```{r Reverse}
cars %>% ggplot(aes(x = speed, y = dist)) +
 geom_point() + geom_smooth(method = "lm", formula =  y ~ x) + scale_x_reverse("Speed") + scale_y_continuous("Stopping Distance") 

cars %>% ggplot(aes(x = speed, y = dist)) + geom_point() + geom_smooth(method = "lm", formula =  y ~ x) + scale_x_continuous("speed") + scale_y_reverse("Stopping Distance")
```
```{r Species.Modify}
iris %>% ggplot(aes(x = Species, y = Petal.Length)) +
 geom_boxplot() + geom_jitter(width = 0.1, height = 0.1) 

iris %>% ggplot(aes(x = Species, y = Petal.Length)) +
 geom_boxplot() + geom_jitter(width = 0.1, height = 0.1) +
 scale_x_discrete(labels = c("setosa" = "Setosa",
 "versicolor" = "Versicolor", "virginica" = "Virginica")) 

iris %>% ggplot(aes(x = Species, y = Sepal.Length)) +
 geom_boxplot() + geom_jitter(width = 0.001, height = 0.001) + scale_x_discrete(labels = c("setosa" = "Setosa",
 "versicolor" = "Versicolor", "virginica" = "Virginica")) 

#??geom_jitter
``` 
```{r Color.Species}
iris %>% gather(Measurement, Value, -Species) %>%
 ggplot(aes(x = Species, y = Value, fill = Species)) +
 geom_boxplot() + facet_grid(Measurement ~ ., scale = "free_y", labeller = labeller(Measurement = label_map))

iris %>% gather(Measurement, Value, -Species) %>%
 ggplot(aes(x = Species, y = Value, fill = Species)) +
 geom_boxplot() + scale_fill_manual(values = c("red", "green", "blue")) + facet_grid(Measurement ~ ., scale = "free_y", labeller = labeller(Measurement = label_map)) 
```
```{r Greens}
iris %>% gather(Measurement, Value, -Species) %>%
 ggplot(aes(x = Species, y = Value, fill = Species)) +
 geom_boxplot() + scale_fill_brewer(palette = "Greens") +
 facet_grid(Measurement ~ ., scale = "free_y", labeller = labeller(Measurement = label_map)) 

#theme_set(theme_bw(2)) 

#old <- theme_set(theme_bw())
#theme_set(old)
#theme_replace(panel.grid.minor = element_line(colour = "red"))
```

```{r Reds}
iris %>% gather(Measurement, Value, -Species) %>%
 ggplot(aes(x = Species, y = Value, fill = Species)) +
 geom_boxplot() + scale_x_discrete(labels = c("setosa" = "Setosa", "versicolor" = "Versicolor", "virginica" = "Virginica")) + scale_fill_brewer(palette = "Reds") +
 facet_grid(Measurement ~ ., switch = "y", labeller = labeller(Measurement = label_map)) + coord_flip() 
``` 
```{r Blues}
iris %>% gather(Measurement, Value, -Species) %>%
 ggplot(aes(x = Species, y = Value, fill = Species)) +
 geom_boxplot() + scale_x_discrete(labels = c("setosa" = "Setosa", "versicolor" = "Versicolor", "virginica" = "Virginica")) + scale_fill_brewer(palette = "Blues") +
 facet_grid(Measurement ~ ., switch = "y", labeller = labeller(Measurement = label_map)) + coord_flip()
```
```{r Top.Position}
iris %>% gather(Measurement, Value, -Species) %>%
 ggplot(aes(x = Species, y = Value, fill = Species)) +
 geom_boxplot() + scale_x_discrete(labels = c("setosa" = "Setosa", "versicolor" = "Versicolor", "virginica" = "Virginica")) + scale_fill_brewer(palette = "Greens") +
 facet_grid(Measurement ~ ., switch = "y", labeller = labeller(Measurement = label_map)) + coord_flip() + theme(strip.background = element_blank()) + theme(legend.position ="top")
```
```{r Bottom}
label_map <- c(Petal.Width = "Petal Width",Petal.Length = "Petal Length",Sepal.Width = "Sepal Width",Sepal.Length = "Sepal Length")
 
species_map <- c(setosa = "Setosa",versicolor = "Versicolor",virginica = "Virginica")
 
iris %>% gather(Measurement, Value, -Species) %>%
 ggplot(aes(x = Species, y = Value, fill = Species)) +
 geom_boxplot() + scale_x_discrete(labels = species_map) +
 scale_fill_brewer(palette = "Greens", labels = species_map) + facet_grid(Measurement ~ ., switch = "y",
 labeller = labeller(Measurement = label_map)) +
 coord_flip() + theme(strip.background = element_blank()) +
 theme(legend.position="bottom") 
``` 

```{r} 
### Figures with Multiple Plots
petal <- iris %>% ggplot() +
 geom_point(aes(x = Petal.Width, y = Petal.Length,
 color = Species)) + theme(legend.position = "none")
 
sepal <- iris %>% ggplot() +
 geom_point(aes(x = Sepal.Width, y = Sepal.Length,
 color = Species)) + theme(legend.position = "none")
 
library(gridExtra)
grid.arrange(petal, sepal, nrow = 2, ncol = 1)

grid.arrange(petal, sepal, nrow = 1, ncol= 2)

library(cowplot)
plot_grid(petal, sepal, labels = c("A", "B"))
```

```{r}
## **Chapter 5** 
### Working With Larges Data sets
iris %>% sample_n(size = 10)
iris %>% sample_frac(size = 0.02) 

library(pryr) 
mem_change(x <- rnorm(10000)) 
mem_change(x[1] <- 0) 
mem_change(y <- x) 
mem_change(x[1] <- 0) 
```

```{r}
d <- data.frame(x = rnorm(10000), y = rnorm(10000))

d %>% ggplot(aes(x = x, y = y)) + geom_point(alpha = 0.2)

mem_change(d)

d %>% ggplot(aes(x = x, y = y)) + geom_density_2d()

mem_change(d)
``` 
```{r}
#install.packages("hexbin")
d %>% ggplot(aes(x = x, y = y)) + geom_hex() + scale_fill_gradient(low = "lightgray", high = "red") + geom_density2d(color = "black")

d %>% ggplot(aes(x = x, y = y)) + geom_hex()
```

```{r}
library(ff)

ffcars <- as.ffdf(cars)
summary(ffcars)

ffiris <- as.ffdf(iris)
summary(ffiris)
```

```{r warning=FALSE}
library(biglm)

model <- biglm(dist ~ speed, data = ffcars)
summary(model) 

iris_db <- src_sqlite("iris_db.sqlite3", create = TRUE)

iris_sqlite <- tbl(iris_db, "iris", temporary = FALSE)

iris_sqlite %>% group_by(Species) %>%
 summarise(mean.Petal.Length = mean(Petal.Length))
```

```{r Regression} 
## **Chapter 6** 
## **Supervise Machine Learning**
### Linear Regression
cars %>% head()
cars %>% ggplot(aes(x = speed, y = dist)) + geom_point() + geom_smooth(method = "lm", formula = y ~ x) 
cars %>% lm(dist ~ speed, data = .) %>% summary 
cars %>% lm(dist ~ speed, data = .) %>% coefficients 
cars %>% lm(dist ~ speed, data = .) %>% confint 
```
```{r Predict}
predict_dist <- function(speed, theta_1)
 data.frame(speed = speed,
 dist = theta_1 * speed,
 theta = as.factor(theta_1))

cars %>% ggplot(aes(x = speed, y = dist, colour = theta)) +
 geom_point(colour = "black") +
 geom_line(data = predict_dist(cars$speed, 2)) +
 geom_line(data = predict_dist(cars$speed, 3)) +
 geom_line(data = predict_dist(cars$speed, 4)) +
 scale_color_discrete(name = expression(theta[1]))
```

```{r}
thetas <- seq(0, 5, length.out = 50)

fitting_error <- Vectorize(function(theta)
 sum((theta * cars$speed - cars$dist)**2)
) 

data.frame(thetas = thetas, errors = fitting_error(thetas)) %>%
 ggplot(aes(x = thetas, y = errors)) +
 geom_line() +
 xlab(expression(theta[1])) + ylab("") 
```

```{r without y_intercept}
cars %>% lm(dist ~ speed - 1, data = .) %>% coefficients
 
cars %>% ggplot(aes(x = speed, y = dist)) +
 geom_point() +
 geom_smooth(method = "lm", formula = y ~ x - 1)
```

```{r jitter}
### Logistic Regression
data("BreastCancer")
BreastCancer %>% head
BreastCancer %>% ggplot(aes(x = Cl.thickness, y = Class)) +
 geom_jitter(height = 0.05, width = 0.3, alpha = 0.4)
 
#data("BreastCancer")
#BreastCancer %>% sample_frac(0.4) %>% head
BreastCancer %>% ggplot(aes(x = Cell.size, y = Class)) +
geom_jitter(height = 0.05, width = .3, alpha = 0.4)
```

```{r height}
BreastCancer %>%
 mutate(Cl.thickness.numeric =
 as.numeric(as.character(Cl.thickness))) %>%
 mutate(IsMalignant = ifelse(Class == "benign", 0, 1)) %>%
 ggplot(aes(x = Cl.thickness.numeric, y = IsMalignant)) + geom_jitter(height = 0.05, width = 0.3, alpha=0.4) +
 geom_smooth(method = "glm", formula = y ~ x, 
 method.args = list(family = "binomial")) 

BreastCancer %>% mutate(Cl.thickness.numeric =
 as.numeric(as.character(Cl.thickness))) %>%
 mutate(IsMalignant = ifelse(Class == "benign", 0, 1)) %>%
 glm(IsMalignant ~ Cl.thickness.numeric,
 family = "binomial", data = .) 
```

```{r Model.M}
### Model Matrice and Formula
cars %>% model.matrix(dist ~ speed, data = .) %>% head(5)

cars %>% model.matrix(dist ~ speed - 1, data = .) %>% head(5) 
```

```{r Size + Thickness} }
BreastCancer %>%
 mutate(Cl.thickness.numeric =
 as.numeric(as.character(Cl.thickness)),
 Cell.size.numeric =
 as.numeric(as.character(Cell.size))) %>%
 mutate(IsMalignant = ifelse(Class == "benign", 0, 1)) %>%
 model.matrix(IsMalignant ~ Cl.thickness.numeric + Cell.size.numeric,
 data = .) %>% head() 
```

```{r without intercept}
BreastCancer %>%
 mutate(Cl.thickness.numeric =
 as.numeric(as.character(Cl.thickness)),
 Cell.size.numeric =
 as.numeric(as.character(Cell.size))) %>%
 mutate(IsMalignant = ifelse(Class == "benign", 0, 1)) %>%
 model.matrix(IsMalignant ~ Cl.thickness.numeric + Cell.size.numeric - 1,
 data = .) %>% head() 
```

```{r without_inercept}
BreastCancer %>%
 mutate(Cl.thickness.numeric =
 as.numeric(as.character(Cl.thickness)),
 Cell.size.numeric =
 as.numeric(as.character(Cell.size))) %>%
 mutate(IsMalignant = ifelse(Class == "benign", 0, 1)) %>%
 glm(IsMalignant ~ Cl.thickness.numeric + Cell.size.numeric - 1, family = "binomial", data = .)
```

```{r with_intercept}
 BreastCancer %>%
 mutate(Cl.thickness.numeric =
 as.numeric(as.character(Cl.thickness)),
 Cell.size.numeric =
 as.numeric(as.character(Cell.size))) %>%
 mutate(IsMalignant = ifelse(Class == "benign", 0, 1)) %>%
 glm(IsMalignant ~ Cl.thickness.numeric + Cell.size.numeric,
 family = "binomial", data = .) 
```

```{r Bare.nuclei}
BreastCancer %>%
 mutate(IsMalignant = ifelse(Class == "benign", 0, 1)) %>%
 model.matrix(IsMalignant ~ Bare.nuclei, data = .) %>%
 head() 
```

```{r Cl}
BreastCancer %>%
 mutate(IsMalignant = ifelse(Class == "benign", 0, 1)) %>%
 model.matrix(IsMalignant ~ Cl.thickness, data = .) %>%
 head() 
```

```{r thickness*size}
BreastCancer %>%
 mutate(Cl.thickness.numeric =
 as.numeric(as.character(Cl.thickness)),Cell.size.numeric =
 as.numeric(as.character(Cell.size))) %>%
 mutate(IsMalignant = ifelse(Class == "benign", 0, 1)) %>%
 model.matrix(IsMalignant ~ Cl.thickness.numeric * Cell.size.numeric, data = .) %>% head() 
```

```{r thickness* nuclei}
BreastCancer %>%
 mutate(Cl.thickness.numeric =
 as.numeric(as.character(Cl.thickness))) %>%
 mutate(IsMalignant = ifelse(Class == "benign", 0, 1)) %>%
 model.matrix(IsMalignant ~ Cl.thickness.numeric * Bare.nuclei, data = .) %>% head() 
```

```{r benign}
BreastCancer %>%
 mutate(Cl.thickness.numeric =
 as.numeric(as.character(Cl.thickness))) %>%
 mutate(IsMalignant = ifelse(Class == "benign", 0, 1)) %>%
 model.matrix(IsMalignant ~ Cl.thickness.numeric : Bare.nuclei, data = .) %>% head() 
```

```{r poly}
cars %>% model.matrix(dist ~ speed + speed^2, data = .) %>% head 
```

```{r poly.1}
### Polynomial function
cars %>% model.matrix(dist ~ speed + I(speed^2), data = .) %>% head 
 
cars %>% lm(dist ~ speed + I(speed^2), data = .) %>%
 summary

cars %>% ggplot(aes(x = speed, y = dist)) + geom_point() +
 geom_smooth(method = "lm", formula = y ~ x + I(x^2))
```

```{r}
iris %>% model.matrix(Sepal.Width ~ Sepal.Length, data = .) %>% head

iris %>% model.matrix(Sepal.Width ~ Sepal.Length + I(Sepal.Length^2), data=.) %>% head()

iris %>% lm(Sepal.Width ~ Sepal.Length + I(Sepal.Length^2), data = .) %>% summary

iris %>% ggplot(aes(x = Sepal.Width, y = Sepal.Length)) + geom_point( color = "lightgreen") +
 geom_smooth(method = "lm", formula = y ~ x + I(x^2))
```

```{r Mod}
### Validating Models
line <- cars %>% lm(dist ~ speed, data = .)

poly <- cars %>% lm(dist ~ speed + I(speed^2), data = .)

predict(line, cars) %>% head

predict(poly, cars) %>% head 
```

```{r rmse}
### Evaluating Regression Models
rmse <- function(x,t) sqrt(mean(sum((t - x)^2)))
rmse(predict(line, cars), cars$dist)
rmse(predict(poly, cars), cars$dist)
```

```{r train_test}
training_data <- cars[1:25,]
test_data <- cars[26:50,] 
line <- training_data %>% lm(dist ~ speed, data = .)
poly <- training_data %>% lm(dist ~ speed + I(speed^2), data = .) 
rmse(predict(line, test_data), test_data$dist) 
rmse(predict(poly, test_data), test_data$dist) 

sampled_cars <- cars %>% mutate(training = sample(0:1, nrow(cars), replace = TRUE))
sampled_cars %>% head 
```

```{r}
training_data <- sampled_cars %>% filter(training == 1)
test_data <- sampled_cars %>% filter(training == 0)
training_data %>% head 
test_data %>% head 

line <- training_data %>% lm(dist ~ speed, data = .)
poly <- training_data %>% lm(dist ~ speed + I(speed^2), data = .) 
rmse(predict(line, test_data), test_data$dist) 
rmse(predict(poly, test_data), test_data$dist) 
```

```{r response}
### Evaluating Classification Models
formatted_data <- BreastCancer %>%
 mutate(Cl.thickness.numeric =
 as.numeric(as.character(Cl.thickness)),
 Cell.size.numeric =
 as.numeric(as.character(Cell.size))) %>%
 mutate(IsMalignant = ifelse(Class == "benign", 0, 1))
 
 fitted_model <- formatted_data %>%
 glm(IsMalignant ~ Cl.thickness.numeric + Cell.size.numeric, data = .)

predict(fitted_model, formatted_data, type = "response") %>% head 
```

```{r Matrix}
### Confusion Matrix
classify <- function(probability) ifelse(probability < 0.5, 0, 1)
classified_malignant <- classify(predict(fitted_model, formatted_data)) 
table(formatted_data$IsMalignant, classified_malignant) 
```

```{r with_name}
table(formatted_data$IsMalignant, classified_malignant,
 dnn = c("Data", "Predictions"))

classify <- function(probability)
 ifelse(probability < 0.5, "benign", "malignant")

classified <- classify(predict(fitted_model, formatted_data))
table(formatted_data$Class, classified, dnn = c("Data", "Predictions")) 
``` 

```{r acc} 
### Accuracy
confusion_matrix <- table(formatted_data$Class, classified,dnn = c("Data", "Predictions"))

(accuracy <- sum(diag(confusion_matrix))/sum(confusion_matrix))
 
#table(BreastCancer$Class) 
```

```{r}
tbl <- table(BreastCancer$Class)
tbl["benign"] / sum(tbl)

mbl = table (BreastCancer$Class)
mbl["malignant"] / sum(mbl)
```

```{r Random_sampling}
table(BreastCancer$Class, sample(BreastCancer$Class)) # random sampling

#replicate(8, acc(table(BreastCancer$Class,sample(BreastCancer$Class))))

#(accuracy(table(BreastCancer$Class,sample(BreastCancer$Class))))
```
```{r Neg.Pos}
### Sensitivity and Specificity
(specificity <- confusion_matrix[1,1]/
 (confusion_matrix[1,1] + confusion_matrix[1,2])) # negative class

(sensitivity <- confusion_matrix[2,2]/
 (confusion_matrix[2,1] + confusion_matrix[2,2])) # positive class
```

```{r random_prediction}
specificity <- function(confusion_matrix)
 confusion_matrix[1,1]/(confusion_matrix[1,1] + confusion_matrix[1,2])
 
sensitivity <- function(confusion_matrix)
 confusion_matrix[2,2]/(confusion_matrix[2,1] + confusion_matrix[2,2])
 
prediction_summary <- function(confusion_matrix)
 c("accuracy" = accuracy(confusion_matrix),
 "specificity" = specificity(confusion_matrix),
 "sensitivity" = sensitivity(confusion_matrix))
 
random_prediction_summary <- function()
 prediction_summary(table(BreastCancer$Class,
 sample(BreastCancer$Class)))
 
#replicate(3, random_prediction_summary())
```

```{r Mease}
### Other Measures
confusion_matrix[2,1] / sum(confusion_matrix[,1])
confusion_matrix[1,1] / sum(confusion_matrix[,1]) 

confusion_matrix[2,2] / sum(confusion_matrix[,2]) 
confusion_matrix[1,2] / sum(confusion_matrix[,2]) 
```

```{r Perm}
### Random Permutation of Data
permuted_cars <- cars[sample(1:nrow(cars)),]
permuted_cars %>% head()

permute_rows <- function(df) df[sample(1:nrow(df)),]
permuted_cars <- cars %>% permute_rows

group_data <- function(df, n) {
 groups <- rep(1:n, each = nrow(df)/n)
 split(df, groups)
}
cars %>% permute_rows %>% group_data(5) %>% head(1)
```

```{r group_cars, warning=FALSE}
grouped_cars <- cars %>% permute_rows %>% group_data(5)
grouped_cars[[1]] 
grouped_cars[1] 

(grouped_cars[[1]] %>%
 lm(dist ~ speed, data = .) %>%.$coefficients)
 
qplot(grouped_cars[[1]] %>%lm(dist ~ speed, data = .) %>%.$coefficients)
```


```{r est}
estimates <- grouped_cars[[1]] %>%
 lm(dist ~ speed, data = .) %>%.$coefficients

for (i in 2:length(grouped_cars)) {
 group_estimates <- grouped_cars[[i]] %>%
 lm(dist ~ speed, data = .) %>%
 .$coefficients
 estimates <- rbind(estimates, group_estimates)
}
estimates 
```

```{r esti}
library(purrr) 

estimates <- grouped_cars %>%
 map(. %>% lm(dist ~ speed, data = .) %>% .$coefficients)
 
estimates 

estimates <- grouped_cars %>%
 map(. %>% lm(dist ~ speed, data = .) %>% .$coefficients) %>% do.call("rbind", .)
 
estimates
```

```{r valid}
### Cross Validation
cross_validation_groups <- function(grouped_df) {
 result <- vector(mode = "list", length = length(grouped_df))
 for (i in seq_along(grouped_df)) {
 result[[i]] <- grouped_df[-i] %>% do.call("rbind", .)
 }
 result
} 

cars %>% permute_rows %>% group_data(5) %>% cross_validation_groups %>% map(. %>% lm(dist ~ speed, data = .) %>% .$coefficients) %>% do.call("rbind", .)
```

```{r split}
cross_validation_split <- function(grouped_df) {
 result <- vector(mode = "list", length = length(grouped_df))
 for (i in seq_along(grouped_df)) {
 training <- grouped_df[-i] %>% do.call("rbind", .)
 test <- grouped_df[[i]]
 result[[i]] <- list(training = training, test = test)
 }
 result
}

cars %>%
 permute_rows %>%
 group_data(5) %>%
 cross_validation_split
```

```{r}
prediction_accuracy_cars <- function(test_and_training) {
 result <- vector(mode = "numeric",
 length = length(test_and_training))
 for (i in seq_along(test_and_training)) {
 training <- test_and_training[[i]]$training
 test <- test_and_training[[i]]$test
 model <- training %>% lm(dist ~ speed, data = .)
 predictions <- test %>% predict(model, data = .)
 targets <- test$dist
 result[i] <- rmse(targets, predictions)
 }
 result
}

cars %>%permute_rows %>%group_data(5) %>% cross_validation_split %>%prediction_accuracy_cars
```

```{r}
random_group <- function(n, probs) {
 probs <- probs / sum(probs)
 g <- findInterval(seq(0, 1, length = n), c(0, cumsum(probs)),
 rightmost.closed = TRUE)
 names(probs)[sample(g)]
}

random_group(8, c(training = 0.5, test = 0.5))

random_group(8, c(training = 0.6, test = 0.4))

random_group(8, c(training = 0.8, test = 0.2)) 

partition <- function(df, n, probs) {
 replicate(n, split(df, random_group(nrow(df), probs)), FALSE)
}

random_cars <- cars %>% partition(4, c(training = 0.5, test = 0.5))

random_cars %>% prediction_accuracy_cars 
```

```{r Tree}
### Decision Tree
library(rpart)

model <- cars %>% rpart(dist ~ speed, data = .)
rmse(predict(model, cars), cars$dist) # root mean square

model <- BreastCancer %>%
 rpart(Class ~ Cl.thickness, data = .) 
predict(model, BreastCancer) %>% head 

predicted_class <- predict(model, BreastCancer) %>%
 as.data.frame %$% ifelse(benign > 0.5, "benign", "malignant")
 
table(BreastCancer$Class, predicted_class)

accuracy = sum(453,147) / sum(453,147,5,94)
accuracy
```

```{r Part}
#install.packages("party")
library(party)
model <- cars %>% ctree(dist ~ speed, data = .)
rmse(predict(model, cars), cars$dist) 

model <- BreastCancer %>%
 ctree(Class ~ Cl.thickness, data = .) 

predict(model, BreastCancer) %>% head 

table(BreastCancer$Class, predict(model, BreastCancer)) 

cars %>% ctree(dist ~ speed, data = .) %>% plot
```

```{r Forest}
### Random Forests
library(randomForest)
model <- cars %>% randomForest(dist ~ speed, data = .)
rmse(predict(model, cars), cars$dist) # root mean square error
 
model <- BreastCancer %>% randomForest(Class ~ Cl.thickness, data = .)
 
predict(model, BreastCancer) %>% head 

table(BreastCancer$Class, predict(model, BreastCancer))

accuracy = sum(437,165) / sum(437,165,76,21)
accuracy
```

```{r Neural}
### Neural Networks
library(nnet)
model <- cars %>% nnet(dist ~ speed, data = ., size = 5)
rmse(predict(model, cars), cars$dist)

model <- BreastCancer %>% nnet(Class ~ Cl.thickness, data = ., size = 5)

predict(model, BreastCancer) %>% head 

predicted_class <- predict(model, BreastCancer) %>%
 { ifelse(. < 0.5, "benign", "malignant") }
 
table(BreastCancer$Class, predicted_class)

accuracy = sum(437,165) / sum(437,165,76,21)
accuracy
```
```{r Machines}
### Support Vector Machines
#install.packages("kernlab")
library(kernlab)

model <- cars %>% ksvm(dist ~ speed, data = .)
rmse(predict(model, cars), cars$dist)

model <- BreastCancer %>% ksvm(Class ~ Cl.thickness, data = .)

predict(model, BreastCancer) %>% head 

table(BreastCancer$Class, predict(model, BreastCancer))
```

```{r Naive}
### Naive Bayes
library(e1071)

model <- BreastCancer %>% naiveBayes(Class ~ Cl.thickness, data = .)

predict(model, BreastCancer) %>% head

table(BreastCancer$Class, predict(model, BreastCancer))
```

```{r Pca}
## **Chapter Seven** 
### **Unsupervised Learning**
### Principal Component Analysis
iris %>% head()

#iris %>% ggplot() + geom_point(aes(x = Sepal.Length, y = Sepal.Width, colour = Species))

#iris %>% ggplot() + geom_point(aes(x = Petal.Length, y = Petal.Width, colour = Species))

pca <- iris %>% select(-Species) %>% prcomp
pca
pca %>% plot

#?prcomp
```

```{r Pred}
mapped_iris <- pca %>% predict(iris)
mapped_iris %>% head

mapped_iris %>%
 as.data.frame %>%
 cbind(Species = iris$Species) %>%
 ggplot() + geom_point(aes(x = PC1, y = PC2, colour = Species))
```

```{r house}
data(HouseVotes84)
HouseVotes84 %>% head(na.rm = TRUE)

vote_patterns <- HouseVotes84 %>% select(-Class) %>% apply(c(1,2), . %>% { ifelse(as.character(.) == "n", 0, 1) }) %>% apply(c(1,2), . %>% { ifelse(is.na(.), 0.5, .) })

pca <- vote_patterns %>% prcomp
#pca %>% head
pca %>% plot
```

```{r votes}
mapped_votes <- pca %>% predict(vote_patterns)

mapped_votes %>%as.data.frame %>% cbind(Class = HouseVotes84$Class) %>% ggplot() + geom_point(aes(x = PC1, y = PC2, colour = Class))
``` 

```{r dimen}
### Multidimensional Scaling 
iris_dist <- iris %>% select(-Species) %>% dist

mds_iris <- iris_dist %>% cmdscale(k = 2)

mds_iris %>% head

mds_iris %>% as.data.frame %>%
 cbind(Species = iris$Species) %>% ggplot() +
 geom_point(aes(x = V1, y = V2, colour = Species))
```

```{r mds}
mds_votes <- vote_patterns %>% dist %>% cmdscale(k = 2 )

mds_votes %>% as.data.frame %>% cbind(Class = HouseVotes84$Class) %>% ggplot() + geom_point(aes(x = V1, y = V2, colour = Class))
```
```{r}
random_ngram <- function(n)
 sample(c('C','H','A','R','L','E','S'), size = n, replace = TRUE) %>% paste0(collapse = "")

random_string <- function(m) {
 n <- max(1, m + sample(c(-1,1), size = 1) * rgeom(1, 1/2))
 random_ngram(n)
}

strings <- replicate(10, random_string(5))
#install.packages("stringdist")
library(stringdist)
string_dist <- stringdistmatrix(strings)
string_dist %>% cmdscale(k = 4) %>% as.data.frame %>%
 cbind(String = strings) %>% ggplot(aes(x = V1, y = V2)) +
 geom_point() + geom_label(aes(label = String), hjust = 0, nudge_y = -0.1)
```

```{r clust}
### Kmeans
clusters <- iris %>% select(-Species) %>% kmeans(centers = 3)

clusters$centers

#clusters$cluster %>% head

clusters$cluster %>% table

iris %>% cbind(Cluster = clusters$cluster) %>%
 ggplot() + geom_bar(aes(x = Species, fill = as.factor(Cluster)), position = "dodge") + scale_fill_discrete("Cluster")
```

```{r cent}
pca <- iris %>% select(-Species) %>% prcomp
 
mapped_iris <- pca %>% predict(iris)
 
mapped_centers <- pca %>% predict(clusters$centers)

mapped_iris %>%
 as.data.frame %>%
 cbind(Species = iris$Species,
 Clusters = as.factor(clusters$cluster)) %>%
 ggplot() +
 geom_point(aes(x = PC1, y = PC2,
 colour = Species, shape = Clusters)) +
 geom_point(aes(x = PC1, y = PC2),
 size = 5, shape = "X",
 data = as.data.frame(mapped_centers))

table(iris$Species, clusters$cluster)

tbl <- table(iris$Species, clusters$cluster)
(counts <- apply(tbl, 1, which.max))

tbl <- table(iris$Species, clusters$cluster)
(counts <- apply(tbl, 1, which.min))

map <- rep(NA, each = 3)
map[counts] <- names(counts)
table(iris$Species, map[clusters$cluster])

#?prcomp
```

```{r hier}
## Hierarchical Clustering
iris_dist <- iris %>% select(-Species) %>% scale %>% dist

clustering <- hclust(iris_dist)

plot(clustering)
```

```{r gend}
library(ggdendro)
ggdendrogram(clustering) + theme_dendro()

clusters <- clustering %>% cutree(k = 2)

iris %>% cbind(Cluster = clusters) %>%
 ggplot() + geom_bar(aes(x = Species, fill = as.factor(Cluster)), position = "dodge") +
 scale_fill_discrete("Cluster")
```

```{r map_iris}
mapped_iris %>% as.data.frame %>%
 cbind(Species = iris$Species,
 Clusters = as.factor(clusters)) %>%
 ggplot() + geom_point(aes(x = PC1, y = PC2,
 shape = Species, colour = Clusters))
```

```{r message=FALSE, warning=FALSE}
## Association Rules
library(arules)

data(income)
income %>% head

data(Income)
Income %>% head

rules <- income %>% apriori
rules %>% head %>% inspect(linebreak = FALSE)

rules %>% sort(by = "lift") %>% head %>% inspect(linebreak = FALSE)

rules %>% subset(support > 0.5) %>% sort(by = "lift") %>%
 head %>% inspect(linebreak = FALSE)
```

```{r More}
# **Chapter 8**
## **More on R Programming**

3 %% 4

3 %/% 4

3/4

1 : 2 ^ 4

-1 : 2
```
```{r logic}
!TRUE

!FALSE

x <- c(TRUE, FALSE, TRUE, FALSE)

y <- c(TRUE, TRUE, FALSE, FALSE)

x | y

FALSE | TRUE

FALSE || TRUE
```
```{r num}
is.numeric(2)

x <- as.integer(2)

is.integer(x)

as.integer(3.2)

as.character(9.99999)

sqrt(as.complex(1))

x <- 5 > 4
x
class(x)
is.logical(x)
```
```{r hello}
x <- "hello, world"
class(x)
is.character(x)

as.character(3.14) 

rep("foo", 10)

v <- 1:3
is.atomic(v)

v <- 1:3
is.vector(v)
attr(v, "foo") <- "bar"
v
is.vector(v)
```
```{r concat}
c(1, 2, c(3, 4), c(5, 6, 7))

c(1, 2, 3, "foo") -> vec
vec
is.vector(vec)
is.character(vec)
```
```{r att}
v <- 1:6

attributes(v)

dim(v) <- c(2, 3)

attributes(v)

dim(v)

v
```
```{r mat}
v <- 1:6
matrix(data = v, nrow = 2, ncol = 3, byrow = FALSE)
matrix(data = v, nrow = 2, ncol = 3, byrow = TRUE)

(A <- matrix(1:4, nrow = 2))
(B <- matrix(5:8, nrow = 2))

A * B # element-wise mult
A %*% B

t(A)
solve(A) ### inverse
solve(A) %*% A ### identity matrix
```
```{r}
list(1:3, 5:8)

list(1:3, c(TRUE, FALSE))

list((1:4), (5:8), (9:12))

unlist(list(1:4, 5:7))
#?'%%'
#?`[[`
```

```{r div}
v <- 1:4
v[2]
v[2:3]
v[c(1,1,4,3,2)]
v[-1]
v[-(1:2)]
v[v %% 2 == 0]
v[v %% 2 == 0] <- 13
v
```
```{r drop}
m <- matrix(1:6, nrow = 2, byrow = TRUE)
m
m[1,]
m[,1]
m[1:2,1:2]
m[1,,drop = FALSE]
m[,1,drop = FALSE]
L <- list(1,2,3)
L[1]
L[2:3]
L[[1]]
L[[2]]
L[[3]]
```
```{r Named}
### Named Values
v <- c(a = 1, b = 2, c = 3, d = 4)
v
L <- list(a = 1:5, b = c(TRUE, FALSE))
L
names(v) <- LETTERS[1:4]
v
v["A"]
L["a"]
L[["a"]]
L$a
```
```{r control}
### Control Structures
if (10 < 12) {
 print("Yes")
} else {
 print("No")
}

x = 100
if (x < 0) {
 print("Negative")
} else if (x > 0) {
 print("Positive")
} else {
 print("Nothing")
}
```
```{r structure}
if (x > 0) "positive" else if (x < 0) "negative" else "zero"

if (x > 0) {
 print("positive")
}else if (x < 0){
 print("negative")
}else{
 print("zero")
}

for (i in 1:10) {
 print(i * i)
}
```
```{r foo_bar_baz}
x <- c("foo", "bar", "baz")
for (i in seq_along(x)) {
 print(i)
 print(x[i])
}

for (i in seq_along(x)) {
 if (i %% 2 == 0) {
 next
 }
 print(x[i])
}
```
```{r divided_two}
for (i in 1:100) {
 if (i %% 2 == 0) {
 next
 }
 if (i > 20) {
 break
 }
 print(i)
}
```
```{r while_loop}
i <- 1
while (i < 5) {
 i <- i + 1
 print(i)
}

i <- 1
repeat {
 print(i)
 i <- i + 1
 if (i > 5) break
}
```
```{r world}
### Function
f <- function() {
 print("hello, world")
 (5 + 4) + (4 ** 2)
}
f()
```

```{r Plus_div}
plus <- function(x, y) {
 print(paste(x, "+", y, "is", x + y))
 x + y
}
plus(2, 2)

div <- function(x, y) {
 print(paste(x, "/", y, "is", x / y))
 x / y}

div (6,2)
div(3,4)
div(y = 2, x = 6)

pow <- function(x, y = 2) x^y
pow(2)
pow(3)
pow(4)
pow(8)
pow(9,2)
pow(8,0)
```
```{r safe}
safer_div <- function(x, y) {
 if (y == 0) {
 NA
 } else {
 x / y
 }
}
safer_div(2,4)
safer_div(3,9)

safer_div <- function(x, y) {
 if (y == 0) {
 return(NA)
 }
 x / y
}
safer_div(3,6)
safer_div(1,0)
```
```{r func}
f <- function(x, y = x^2) y + x
f(7)

g <- function(x, y = x^2) { x <- 0; y + x }
g(2)
g(2,9)

h <- function(x, y = x^2) { y; x <- 0; y + x }
h(2)
h(8)
```
```{r scop_1}
### Scoping
x <- "x"
f <- function(y) {
 g <- function() c(x, y)
 g()
}
f("y")

x <- "x"
f <- function(y) {
 g <- function() c(x, y)
 y <- "z"
 g()
}
f("y")
```
```{r scop_2}
x <- "x"
f <- function(y) {
 g <- function() c(x, y)
 g
}
g <- f("y")
g()

x <- "x"
f <- function(y) {
 g <- function() c(x, y)
 g
}
g <- f("u")
g()

h <- f("z")
h()
```
```{r null}
f <- function() {
 x <- NULL
 set <- function(val) { x <- val }
 get <- function() x
 list(set = set, get = get)
}
x <- f()
x$get()

x$set(5)
x$get()
```

```{r}
f <- function(){
x <- NULL
 set <- function(val) { x <<- val }
 get <- function() x
 list(set = set, get = get)
}
x <- f()
x$get()

x$set(5)
x$get()
```

```{r fact}
n <- function(x) x
f <- function(n) n(n)
f(5)

f(function(x) 15)

factorial <- function(n) {
 if (n == 1) {
 1
 } else {
 n * factorial(n - 1)
 }
}
factorial(9)
factorial(1)
```

```{r merge}
merge <- function(x, y) {
 if (length(x) == 0) return(y)
 if (length(y) == 0) return(x)
 if (x[1] < y[1]) {
 c(x[1], merge(x[-1], y))
 } else {
 c(y[1], merge(x, y[-1]))
 }
}
merge(9,0)
merge(12,5)
```

```{r merge_sort}
merge_sort <- function(x) {
 if (length(x) < 2) return(x)
 n <- length(x)
 m <- n %/% 2
 merge(merge_sort(x[1:m]), merge_sort(x[(m+1):n]))}
merge_sort (10)
```

```{r prog}
# **Chapter 9**
### **Advance R Programming**
(x <- 2 / 3)

(y <- x ** 2)

(x <- 1:4 / 3)

(y <- x ** 2)
```
```{r vect}
x <- 1:5
y <- 6:10
(z <- x + y)
(s = y -  x)

z <- vector(length = length(x))
for (i in seq_along(x)) {
 z[i] <- x[i] + y[i]
}
z

s = vector(length = length(x))
for (i in seq_along(x)){
  s[i] = y[i] - x[i]
}
s
```

```{r pow_}
sqrt((1:5)**2)

sin(sqrt((1:5)**2))

x <- 1:10
y <- 1:2
x + y
```

```{r if_else}
x <- 1:10
ifelse(x %% 2 == 0, 5, 15)

f <- function(x, y) sqrt(x ** y)
f(1:6, 2)

f(1:6, 1:2)
```

```{r role}
role_table <- list("Thomas" = "Instructor",
 "Henrik" = "Student",
 "Kristian" = "Student",
 "Randi" = "Student",
 "Heidi" = "Student",
 "Manfred" = "Student",
 "Charles" = "Researcher")

map_to_role <- function(name) role_table[[name]]

map_to_role("Thomas")

map_to_role("Charles")

role_table[c("Thomas", "Henrik", "Randi","Charles")]

map_to_role_2 <- function(names) unlist(role_table[names])
x <- c("Thomas", "Henrik", "Randi","Charles")
map_to_role_2(x)
```

```{r lis}
x <- list("first" = list("second" = "foo"), "third" = "bar")
x[[c("first", "second")]]

#x[["first"]][["second"]]
```
```{r apply}
### apply
m <- matrix(1:6, nrow = 2, byrow = TRUE)
m

apply(m, 1, function(x) paste(x, collapse = ":")) # row-wise

apply(m, 2, function(x) paste(x, collapse = ":")) # column-wise

apply(m, c(1,2), function(x) paste(x, collapse = ":")) # Both

apply(m, 1, function(x) c(x,x))

apply(m, 2, function(x) c(x,x))

apply(m, c(1,2), function(x) c(x,x))
```

```{r apply_p}
x <- apply(m, c(1,2), function(x) c(x,x))
k <- dim(x)[3]
n <- dim(x)[2]
for (i in 1:n) {
 for (j in 1:k) {
 print(x[,i,j])
 }
}
```

```{r sumpow}
sumpow <- function(x, n) sum(x) ** n
apply(m, 1, sumpow,n = 2) # row - wise
apply(m, 2, sumpow, n = 2) # column - wise
```

```{r lapply}
### lapply
l <- list(1, 2, 3)
lapply(l, function(x) x**2)

l <- list(a = 1, b = 2, c = 3)
lapply(l, function(x) x**2)

lapply(1:5, function(x) x**4)

lapply(list(a = 1:3, b = 4:6), function(x) x**2)
```

```{r sapply}
### sapply
sapply(1:3, function(x) x**2) # returns vector by default 

vapply(1:3, function(x) x**2,1)

#?vapply
```

```{r adv}
### Advance Functions

`+`(2, 2)
v <- 1:4
names(v) <- c("a", "b", "c", "d")
v

`foo<-` <- function(x, value) {
 x$foo <- value
 x
}

`bar<-` <- function(x, value) {
 x$bar <- value
 x
}

x <- list(foo = 1, bar = 2)
x$foo 
x$bar
foo(x) <- 4
x$foo
bar(x) <- 3
x$bar
```

```{r foo_bar}
y <- x
foo(x) <- 5
x
y

`foo<-` <- function(y, value) {
 y$foo <- value
 y
}

x <- list(foo = 1, bar = 2)
foo(x) <- 3
x$foo
```

```{r foo_bar_1}
`modify<-` <- function(x, variable, value) {
 x[variable] <- value
 x
}

x <- list(foo = 1, bar = 2)
modify(x, "foo") <- 5
modify(x, "bar") <- 7
x$foo
x$bar
```

```{r index}
x <- 1:4
f <- function(x) {
 x[2] <- 5 # insert 5 at index 2
 x[1] <- 9 # insert 9 at index 1 
 x[4] <- 10 # insert 10 at index 4
 x
}
x
f(x)
```

```{r square}
square <- function(x) (x**2 - x)
square(5)

m <- matrix(1:6, nrow = 3)
m

sum_of_squares <- function(x) sum(x^2)
apply(m, 1, sum_of_squares) # row - wise
apply(m,2 , sum_of_squares) # column - wise

#apply(m^2, 1, sum)
```

```{r apply_if}
apply_if <- function(x, p, f) {
 result <- vector(length = length(x))
 n <- 0
 for (i in seq_along(x)) {
 if (p(x[i])) {
 n <- n + 1
 result[n] <- f(x[i])
 }
 }
 head(result, n)
}
apply_if(1:8, function(x) x %% 2 == 0, function(x) x^2)
```

```{r power_cube}
power <- function(n) function(x) x**n
square <- power(2)
cube <- power(3)

x <- 1:4
square(x) 
cube(x)
```

```{r filter_map_reduce}
### Filter, Map and Reduce
is_even <- function(x) x %% 2 == 0
Filter(is_even, 1:8)
Filter(is_even, unlist(1:8))
Filter(is_even, as.list(1:8))

divi <- function(x) (x %% 3 == 0)
Filter(divi, 1:12)

square <- function(x) x^2
Map(square, 1:4)

unlist(Map(square, 1:4))
```

```{r map}
plus <- function(x, y) x + y
unlist(Map(plus, 0:3, 3:0))

add_parenthesis <- function(a, b) paste("(", a, ", ", b, ")", sep = "")
Reduce(add_parenthesis, 1:4)

mysum <- function(x) Reduce(`+`, x)
mysum(1:4)
```

```{r factorail}
### Function Operations
cached <- function(f) {
 force(f)
 table <- list()
 
function(n) {
 key <- as.character(n)
 if (key %in% names(table)) {
 print(paste("I have already computed the value for", n))
 table[[key]]
 } else {
 print(paste("Going to compute the value for", n))
 res <- f(n)
 print(paste("That turned out to be", res))
 table[key] <<- res
 print(table)
 res
 }
 }
}

factorial <- function(n) {
 if (n == 1) {
 1
 } else {
 n * factorial(n - 1)
 }
}

factorial <- cached(factorial)

factorial(4)

factorial(1)

factorial(2)

factorial(3)

factorial(4)

factorial(5)
```
```{r fibonacci}
fibonacci <- function(n) {
 if (n == 1 || n == 2) {
 1
 } else {
 fibonacci(n - 1) + fibonacci(n - 2)
 }
}

fibonacci <- cached(fibonacci)

fibonacci(4)

fibonacci(1)

fibonacci(2)

fibonacci(3)

fibonacci(4)

fibonacci(5)

?fibonacci
```

```{r ellip}
### Ellipsis Parameters
g <- function(a, b, ...) NULL
g(a = 1, b = 2, c = 3)

tolist <- function(...) list(...)
tolist()

tolist(a = 1)

tolist(a = 1, b = 3)
tolist(a = 1, b = 3, c = 4,d = 12, e = 23)

### System Timeout
time_out <- function(f) {
 force(f)
 function(...) {
 system.time(f(...))
 }
}

ti_mean <- time_out(mean)
ti_mean(runif(1e6))
```

```{r blm}
# **Chapter 10**
## **Object Oriented Programming**
### **Bayesian Linear Models**
blm <- function(model, alpha = 1, beta = 1, ...) {
 # Here goes the mathematics for computing the fit.
 frame <- model.frame(model, ...)
 phi <- model.matrix(frame)
 no_params <- ncol(phi)
 target <- model.response(frame)
 covar <- solve(diag(alpha, no_params) + beta * t(phi) %*% phi)
 mean <- beta * covar %*% t(phi) %*% target
 list(formula = model,
 frame = frame,
 mean = mean,
 covar = covar)
}
```

```{r fake}
# fake some data for our linear model
x <- rnorm(10)
a <- 1 ; b <- 1.3
w0 <- 0.2 ; w1 <- 3
y <- rnorm(10, mean = w0 + w1 * x, sd = sqrt(1/b))
#frame <- data.frame (x_1 = x, y_1 = y )
#frame

# fit a model
model <- blm(y ~ x, alpha = a, beta = b)

model

class(model)

class(model) <- "blm"

class(model)
```

```{r simple}
blm <- function(model, alpha = 1, beta = 1, ...) {
 # stuff happens here...
 object <- list(formula = model,
 frame = frame,
 mean = mean,
 covar = covar)
 class(object) <- "blm"
 object
}

blm <- function(model, alpha = 1, beta = 1, ...) {
 # stuff happens here...
 structure(list(formula = model,
 frame = frame,
 mean = mean,
 covar = covar),
 class = "blm")
}

model
```

```{r morphic Function}
### Polymorphic Function
print.blm <- function(x, ...) {
 print(x$formula)
}
model
#??print
```

```{r use_method}
### Defining your own Function
Charles <- function(x, ...) UseMethod("Charles")
Charles.default <- function(x, ...) print("default Charles")
Charles("a string")
#Charles(12)

Charles.blm <- function(x, ...) print("blm Charles")
Charles(model)
```

```{r foo.blm}
Charles.blm <- function(x, upper = FALSE, ...) {
 if (upper) {
 print("BLM FOO")
 } else {
 print("blm foo")
 }
}

Charles("a string")

Charles(model)

Charles("a string", upper = TRUE)

Charles(model, upper = TRUE)
```

```{r foo}
foo <- function(object, ...) UseMethod("foo")
foo.default <- function(object, ...) stop("foo not implemented")

bar <- function(object, ...) UseMethod("bar")
bar.default <- function(object, ...) stop("bar not implemented")


A <- function(f, b) structure(list(foo = f, bar = b), class ="A")

foo.A <- function(object, ...) paste("A::foo ->", object$foo)
bar.A <- function(object, ...) paste("A::bar ->", object$bar)

a <- A("Charles", "Nana")
foo(a)

bar(a)

baz <- function(object, ...) UseMethod("baz")
baz.default <- function(object, ...) stop("baz not implemented")
```

```{r bar.baz}
B <- function(f, b, bb) {
 a <- A(f, b)
 a$baz <- bb
 class(a) <- "B"
 a
}

bar.B <- function(object, ...) paste("B::bar ->", object$bar)
baz.B <- function(object, ...) paste("B::baz ->", object$baz)

B <- function(f, b, bb) {
 a <- A(f, b)
 a$baz <- bb
 class(a) <- c("B", "A")
 a
}

b <- B("Charles", "Kwame", "Appiah")

foo(b)

bar(b)

baz(b)
```

```{r foo.bar.baz}
C <- function(f, b, bb) {
 b <- B(f, b, bb)
 class(b) <- c("C", "B", "A")
 b
}
c <- C("foo", "bar", "baz")
foo(c)

bar(c)

baz(c)

C <- function(f, b, bb) {
 b <- B(f, b, bb)
 class(b) <- c("C", class(b))
 b
}
```

```{r}
# **Chapter 12**
## Testing R packages
area <- function(x) UseMethod("area")

circumference <- function(x) UseMethod("circumference")

rectangle <- function(width, height) {
 structure(list(width = width, height = height),
 class = c("rectangle", "shape"))
}

area.rectangle <- function(x) x$height * x$width

circumference.rectangle <- function(x) 2 * x$height + 2 * x$width

r <- rectangle(width = 3, height = 4)
area(r)

circumference(r)

# Automating testing
r <- rectangle(width = 3, height = 4)
if (area(r) != 3*4) {
 stop("Area not computed correctly!")
}

if (circumference(r) != 2*3 + 2*4) {
 stop("Circumference not computed correctly!")
}
```

```{r}
## **Chapter 14**
### Profiling and  Optimizing
library(profvis)
graph <- function(n, edges) {
 m <- matrix(0, nrow = n, ncol = n)
 no_edges <- length(edges)
 if (no_edges >= 1) {
 for (i in seq(1, no_edges, by = 2)) {
 m[edges[i], edges[i+1]] <- m[edges[i+1], edges[i]] <- 1
 }
 }
 structure(m, class = "graph")
}
```

```{r}
smooth_weights <- function(graph, node_weights, alpha) {
 if (length(node_weights) != nrow(graph))
 stop("Incorrect number of nodes")
 no_nodes <- length(node_weights)
 new_weights <- vector("numeric", no_nodes)
 for (i in 1:no_nodes) {
 neighbour_weights <- 0
 n <- 0
 for (j in 1:no_nodes) {
 if (i != j && graph[i, j] == 1) {
 neighbour_weights <- neighbour_weights + node_weights[j]
 n <- n + 1
 }
 }
 if (n > 0) {
 new_weights[i] <-
 alpha * node_weights[i] +
 (1 - alpha) * neighbour_weights / n
 } else {
 new_weights[i] <- node_weights[i]
 }
 }
 new_weights
}
```

```{r message=FALSE, warning=FALSE}
profvis::profvis({
 n <- 1000
 nodes <- 1:n
 edges <- sample(nodes, 600, replace = TRUE)
 weights <- rnorm(n)
 g <- graph(n, edges)
 smooth_weights(g, weights, 0.8)
})
```

```{r}
graph <- function(n, edges) {
 neighbours <- vector("list", length = n)
 for (i in seq_along(neighbours)) {
 neighbours[[i]] <- vector("integer", length = 0)
 }
 no_edges <- length(edges)
 if (no_edges >= 1) {
 for (i in seq(1, no_edges, by = 2)) {
 n1 <- edges[i]
 n2 <- edges[i+1]
 neighbours[[n1]] <- c(n2, neighbours[[n1]])
 neighbours[[n2]] <- c(n1, neighbours[[n2]])
 }
 }
 for (i in seq_along(neighbours)) {
 neighbours[[i]] <- unique(neighbours[[i]])
 }
 structure(neighbours, class = "graph")
}
```

```{r}
smooth_weights <- function(graph, node_weights, alpha) {
 if (length(node_weights) != length(graph))
 stop("Incorrect number of nodes")
 no_nodes <- length(node_weights)
 new_weights <- vector("numeric", no_nodes)
 for (i in 1:no_nodes) {
 neighbour_weights <- 0
 n <- 0
 for (j in graph[[i]]) {
 if (i != j) {
   neighbour_weights <- neighbour_weights + node_weights[j]
 n <- n + 1
 }
 }
 if (n > 0) {
 new_weights[i] <-
 alpha * node_weights[i] +
 (1 - alpha) * neighbour_weights / n
 } else {
 new_weights[i] <- node_weights[i]
 }
 }
 new_weights
}
```

```{r}
profvis::profvis({
 n <- 10000
 nodes <- 1:n
 edges <- sample(nodes, 600, replace = TRUE)
 weights <- rnorm(n)
 g <- graph(n, edges)
 smooth_weights(g, weights, 0.8)
})
```

```{r}
graph <- function(n, edges) {
 neighbours <- vector("list", length = n)
 for (i in seq_along(neighbours)) {
 neighbours[[i]] <- vector("integer", length = 0)
 }
 no_edges <- length(edges)
 if (no_edges >= 1) {
 sources <- seq(1, no_edges, by = 2)
 destinations <- seq(2, no_edges, by = 2)
 edge_matrix <- matrix(NA, nrow = length(sources), ncol = 2)
 edge_matrix[,1] <- edges[sources]
 edge_matrix[,2] <- edges[destinations]
 for (i in 1:nrow(edge_matrix)) {
 if (edge_matrix[i,1] > edge_matrix[i,2]) {
 edge_matrix[i,] <- c(edge_matrix[i,2], edge_matrix[i,1])
 }
 }
 edge_matrix <- unique(edge_matrix)
 for (i in seq(1, nrow(edge_matrix))) {
 n1 <- edge_matrix[i, 1]
 n2 <- edge_matrix[i, 2]
 neighbours[[n1]] <- c(n2, neighbours[[n1]])
 neighbours[[n2]] <- c(n1, neighbours[[n2]])
 }
 }
 structure(neighbours, class = "graph")
}
```

```{r}
profvis::profvis({
 n <- 20000
 nodes <- 1:n
 edges <- sample(nodes, 50000, replace = TRUE)
 weights <- rnorm(n)
 g <- graph(n, edges)
 smooth_weights(g, weights, 0.8)
})
```


```{r}
flow_weights_iteration <- function(graph, node_weights, alpha) {
 if (length(node_weights) != length(graph))
 stop("Incorrect number of nodes")
   no_nodes <- length(node_weights)
 new_weights <- vector("numeric", n)
 for (i in 1:no_nodes) {
 neighbour_weights <- 0
 n <- 0
 for (j in graph[[i]]) {
 if (i != j) {
 neighbour_weights <- neighbour_weights + node_weights[j]
 n <- n + 1
 }
 }
 if (n > 0) {
 new_weights[i] <- (alpha * node_weights[i] + (1 - alpha)
 * neighbour_weights / n)
 } else {
 new_weights[i] <- node_weights[i]
 }
 }
 new_weights
}
smooth_weights <- function(graph, node_weights, alpha, no_iterations) {
 new_weights <- node_weights
 replicate(no_iterations, {
 new_weights <- flow_weights_iteration(graph, new_weights, alpha)
 })
 new_weights
}
```


```{r message=FALSE}
profvis::profvis({
 n <- 20000
 nodes <- 1:n
 edges <- sample(nodes, 100000, replace = TRUE)
 weights <- rnorm(n)
 g <- graph(n, edges)
 smooth_weights(g, weights, 0.8, 10)
})
```


```{r}
smooth_weights <- function(graph, node_weights,
 alpha, no_iterations) {
 new_weights <- node_weights
 for (i in 1:no_iterations) {
 new_weights <-
 smooth_weights_iteration(graph, new_weights, alpha)
 }
 new_weights
}
```

```{r}
### Increasing Speed
library(microbenchmark)

mysum <- function(sequence) {
 s <- 0
 for (x in sequence) s <- s + x
 s
}
microbenchmark(
 sum(1:10),
 mysum(1:10)
)

microbenchmark(
 sum(1:10),
 mysum(1:10),
 Reduce(`+`, 1:10)
)
```

```{r}
x <- sample(LETTERS, 1000, replace = TRUE)
microbenchmark(
 factor(x, levels = LETTERS),
 factor(x)
)
```

```{r}
x <- rnorm(1000)
names(x) <- paste("n", 1:1000)
microbenchmark(
 unlist(Map(function(x) x**2, x), use.names = FALSE),
 unlist(Map(function(x) x**2, x))
)
```

```{r}
smooth_weights_iteration_map <- function(graph, node_weights, alpha) {
 if (length(node_weights) != length(graph))
 stop("Incorrect number of nodes")
handle_i <- function(i) {
 neighbour_weights <- 0
 n <- 0
 for (j in graph[[i]]) {
 if (i != j) {
 neighbour_weights <- neighbour_weights + node_weights[j]
 n <- n + 1
 }
 }
 if (n > 0) {
 alpha * node_weights[i] + (1 - alpha) * neighbour_weights / n
 } else {
 node_weights[i]
 }
 }
 unlist(Map(handle_i, 1:length(node_weights)))
}
```




library(cluster)
test_rmse <- function(data) {
 model <- data$training %>% lm(dist ~ speed, data = .)
 predictions <- data$test %>% predict(model, data = .)
 rmse(data$test$dist, predictions)
}
sample_rmse <- function (n) {
 random_cars <- cars %>%
 partition(n, c(training = 0.6, test = 0.4))
 unlist(Map(test_rmse, random_cars))
}
sample_rmse_parallel <- function (n) {
 random_cars <- cars %>%
 partition(n, c(training = 0.6, test = 0.4))
 unlist(clustermq(cl, test_rmse, random_cars))
}

microbenchmark(
 sample_rmse(10),
 sample_rmse_parallel(10),
 times = 5
)

microbenchmark(
 sample_rmse(1000),
 sample_rmse_parallel(1000),
 times = 5
)


```{r}
library(Rcpp)
cppFunction("
NumericVector
smooth_weights_iteration_cpp(List g,
 NumericVector node_weights,
double alpha)
{
 NumericVector new_weights(g.length());
 for (int i = 0; i < g.length(); ++i) {
 // The body here is just the C++ code
 // shown above...
 }
 return new_weights;
}
")
```

```{r}
smooth_weights_cpp <- function(graph, node_weights,
 alpha, no_iterations) {
 new_weights <- node_weights
 for (i in 1:no_iterations) {
new_weights <-
 smooth_weights_iteration_cpp(graph, new_weights, alpha)
 }
 new_weights
}
```


library(microbenchmark)
microbenchmark(
 smooth_weights(g, weights, 0.8, 10),
 smooth_weights_cpp(g, weights, 0.8, 10),
 times = 5
)

```{r}
library(rstudioapi)

viewer <- getOption("viewer")
viewer("R-with Data Science.Rmd", height = "maximize")
#rstudioapi::navigateToFile("")
```
